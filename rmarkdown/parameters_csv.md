Using parameters from csv
================
Amy Heather
2025-07-11

## Set-up

Install the latest version of the local simulation package. If running
sequentially, `devtools::load_all()` is sufficient. If running in
parallel, you must use `devtools::install()`.

``` r
devtools::load_all()
```

    ## ℹ Loading simulation

``` r
start_time <- Sys.time()
```

## Creating parameter class

We can set up classes based on CSV, replacing the default inputs with
those from the csv.

If you were only planning to use parameters from CSV, then you could
remove the default inputs from the classes in `parameters.R` altogether.

We use the parameter function to process values from the CSV, ensuring
that all required parameter names are present and that no unexpected
arguments are included. This approach leverages the function’s built-in
validation to catch any issues with argument names or types. If the
parameter classes themselves have validation, those checks will also be
performed when the function is called.

``` r
#' Use parameter function to create parameter list using values from dataframe.
#'
#' @param data Dataframe with columns "unit", "parameter", "type", "mean" and
#' "sd".
#' @param unit Unit name to filter by ("asu" or "rehab").
#' @param parameter Parameter name to filter by ("iat", "los" or "routing").
#' @param param_function Function to run
#'
#' @return Named list of parameters

init_param_class <- function(data, unit, parameter, param_function) {

  # Filter data to specified unit and parameter
  df_subset <- data[data[["unit"]] == unit &
                      data[["parameter"]] == parameter, ]

  # Create named list of parameter values.
  # If all SD values are missing, use only means and name by 'type'.
  # Otherwise, include both mean and sd for each type, with names like
  # 'type_mean' and 'type_sd'.
  if (all(is.na(df_subset$sd))) {
    param_list <- as.list(setNames(df_subset$mean, df_subset$type))
  } else {
    param_list <- list()
    for (i in seq_len(nrow(df_subset))) {
      df_row <- df_subset[i, ]
      param_list[[paste0(df_row$type, "_mean")]] <- df_row$mean
      param_list[[paste0(df_row$type, "_sd")]] <- df_row$sd
    }
  }

  # Run parameter function using list
  do.call(param_function, param_list)
}
```

``` r
#' Generate named_list with create_parameters() using values loaded from a CSV
#' file.
#'
#' @param csv_path Path to csv file containing the parameters. Should have
#' columns "unit", "parameter", "type", "mean" and "sd". Missing values should
#' be marked as "NA".
#'
#' @return Named list generated by create_parameters()

setup_param_from_csv <- function(csv_path) {
  # Load parameter data from CSV, treating "NA" as missing values
  param_data <- read.csv(csv_path, na.strings = "NA")

  # Specify mappings of create_parameters() arguments to their corresponding
  # units, parameter types and parameter classes
  param_specs <- list(
    list(name = "asu_arrivals",
         unit = "asu",
         parameter = "iat",
         param_function = create_asu_arrivals),
    list(name = "rehab_arrivals",
         unit = "rehab",
         parameter = "iat",
         param_function = create_rehab_arrivals),
    list(name = "asu_los",
         unit = "asu",
         parameter = "los",
         param_function = create_asu_los),
    list(name = "rehab_los",
         unit = "rehab",
         parameter = "los",
         param_function = create_rehab_los),
    list(name = "asu_routing",
         unit = "asu",
         parameter = "routing",
         param_function = create_asu_routing),
    list(name = "rehab_routing",
         unit = "rehab",
         parameter = "routing",
         param_function = create_rehab_routing)
  )
  param_kwargs <- list()
  for (spec in param_specs) {
    param_kwargs[[spec$name]] <- init_param_class(
      data = param_data, unit = spec$unit, parameter = spec$parameter,
      param_function = spec$param_function
    )
  }

  do.call(create_parameters, param_kwargs)
}
```

``` r
setup_param_from_csv(file.path("..", "inputs", "parameters.csv"))
```

    ## $asu_arrivals
    ## $asu_arrivals$stroke
    ## [1] 1.2
    ## 
    ## $asu_arrivals$tia
    ## [1] 9.3
    ## 
    ## $asu_arrivals$neuro
    ## [1] 3.6
    ## 
    ## $asu_arrivals$other
    ## [1] 3.2
    ## 
    ## 
    ## $rehab_arrivals
    ## $rehab_arrivals$stroke
    ## [1] 21.8
    ## 
    ## $rehab_arrivals$neuro
    ## [1] 31.7
    ## 
    ## $rehab_arrivals$other
    ## [1] 28.6
    ## 
    ## 
    ## $asu_los
    ## $asu_los$stroke_no_esd
    ## $asu_los$stroke_no_esd$mean
    ## [1] 7.4
    ## 
    ## $asu_los$stroke_no_esd$sd
    ## [1] "8.61"
    ## 
    ## 
    ## $asu_los$stroke_esd
    ## $asu_los$stroke_esd$mean
    ## [1] 4.6
    ## 
    ## $asu_los$stroke_esd$sd
    ## [1] "4.8"
    ## 
    ## 
    ## $asu_los$stroke_mortality
    ## $asu_los$stroke_mortality$mean
    ## [1] 7
    ## 
    ## $asu_los$stroke_mortality$sd
    ## [1] 8.7
    ## 
    ## 
    ## $asu_los$tia
    ## $asu_los$tia$mean
    ## [1] 1.8
    ## 
    ## $asu_los$tia$sd
    ## [1] "2.3"
    ## 
    ## 
    ## $asu_los$neuro
    ## $asu_los$neuro$mean
    ## [1] 4
    ## 
    ## $asu_los$neuro$sd
    ## [1] "5"
    ## 
    ## 
    ## $asu_los$other
    ## $asu_los$other$mean
    ## [1] 3.8
    ## 
    ## $asu_los$other$sd
    ## [1] "5.2"
    ## 
    ## 
    ## 
    ## $rehab_los
    ## $rehab_los$stroke_no_esd
    ## $rehab_los$stroke_no_esd$mean
    ## [1] 28.4
    ## 
    ## $rehab_los$stroke_no_esd$sd
    ## [1] "27.2"
    ## 
    ## 
    ## $rehab_los$stroke_esd
    ## $rehab_los$stroke_esd$mean
    ## [1] 30.3
    ## 
    ## $rehab_los$stroke_esd$sd
    ## [1] "2un3.1"
    ## 
    ## 
    ## $rehab_los$tia
    ## $rehab_los$tia$mean
    ## [1] 18.7
    ## 
    ## $rehab_los$tia$sd
    ## [1] "23.5"
    ## 
    ## 
    ## $rehab_los$neuro
    ## $rehab_los$neuro$mean
    ## [1] 27.6
    ## 
    ## $rehab_los$neuro$sd
    ## [1] "28.4"
    ## 
    ## 
    ## $rehab_los$other
    ## $rehab_los$other$mean
    ## [1] 16.1
    ## 
    ## $rehab_los$other$sd
    ## [1] "14.1"
    ## 
    ## 
    ## 
    ## $asu_routing
    ## $asu_routing$stroke
    ## $asu_routing$stroke$rehab
    ## [1] 0.24
    ## 
    ## $asu_routing$stroke$esd
    ## [1] 0.13
    ## 
    ## $asu_routing$stroke$other
    ## [1] 0.63
    ## 
    ## 
    ## $asu_routing$tia
    ## $asu_routing$tia$rehab
    ## [1] 0.01
    ## 
    ## $asu_routing$tia$esd
    ## [1] 0.01
    ## 
    ## $asu_routing$tia$other
    ## [1] 0.98
    ## 
    ## 
    ## $asu_routing$neuro
    ## $asu_routing$neuro$rehab
    ## [1] 0.11
    ## 
    ## $asu_routing$neuro$esd
    ## [1] 0.05
    ## 
    ## $asu_routing$neuro$other
    ## [1] 0.84
    ## 
    ## 
    ## $asu_routing$other
    ## $asu_routing$other$rehab
    ## [1] 0.05
    ## 
    ## $asu_routing$other$esd
    ## [1] 0.1
    ## 
    ## $asu_routing$other$other
    ## [1] 0.85
    ## 
    ## 
    ## 
    ## $rehab_routing
    ## $rehab_routing$stroke
    ## $rehab_routing$stroke$esd
    ## [1] 0.4
    ## 
    ## $rehab_routing$stroke$other
    ## [1] 0.6
    ## 
    ## 
    ## $rehab_routing$tia
    ## $rehab_routing$tia$esd
    ## [1] 0
    ## 
    ## $rehab_routing$tia$other
    ## [1] 1
    ## 
    ## 
    ## $rehab_routing$neuro
    ## $rehab_routing$neuro$esd
    ## [1] 0.09
    ## 
    ## $rehab_routing$neuro$other
    ## [1] 0.91
    ## 
    ## 
    ## $rehab_routing$other
    ## $rehab_routing$other$esd
    ## [1] 0.13
    ## 
    ## $rehab_routing$other$other
    ## [1] 0.88
    ## 
    ## 
    ## 
    ## $warm_up_period
    ## [1] 1095
    ## 
    ## $data_collection_period
    ## [1] 1825
    ## 
    ## $number_of_runs
    ## [1] 150
    ## 
    ## $scenario_name
    ## NULL
    ## 
    ## $cores
    ## [1] 1
    ## 
    ## $log_to_console
    ## [1] FALSE
    ## 
    ## $log_to_file
    ## [1] FALSE
    ## 
    ## $file_path
    ## NULL

## Calculate run time

``` r
# Get run time in seconds
end_time <- Sys.time()
runtime <- as.numeric(end_time - start_time, units = "secs")

# Display converted to minutes and seconds
minutes <- as.integer(runtime / 60L)
seconds <- as.integer(runtime %% 60L)
cat(sprintf("Notebook run time: %dm %ds", minutes, seconds))
```

    ## Notebook run time: 0m 0s
