---
title: "Using parameters from csv"
author: "Amy Heather"
date: "`r Sys.Date()`"
output:
  github_document:
  toc: true
html_preview: false
---

## Set-up

Install the latest version of the local simulation package. If running sequentially, `devtools::load_all()` is sufficient. If running in parallel, you must use `devtools::install()`.

```{r}
devtools::load_all()
```

```{r}
start_time <- Sys.time()
```

## Creating parameter class

We can set up classes based on CSV, replacing the default inputs with those from the csv.

If you were only planning to use parameters from CSV, then you could remove the default inputs from the classes in `parameters.R` altogether.

We use the parameter function to process values from the CSV, ensuring that all required parameter names are present and that no unexpected arguments are included. This approach leverages the function's built-in validation to catch any issues with argument names or types. If the parameter classes themselves have validation, those checks will also be performed when the function is called.   
```{r}
#' Use parameter function to create parameter list using values from dataframe.
#'
#' @param df Dataframe with columns "unit", "parameter", "type", "mean" and
#' "sd".
#' @param unit Unit name to filter by ("asu" or "rehab").
#' @param parameter Parameter name to filter by ("iat", "los" or "routing").
#' @param param_function Function to run
#' 
#' @return Named list of parameters

init_param_class <- function(df, unit, parameter, param_function) {

  # Filter data to specified unit and parameter
  df_subset <- df[df[["unit"]] == unit & df[["parameter"]] == parameter, ]
  
  # Create named list of parameter values.
  # If all SD values are missing, use only means and name by 'type'.
  # Otherwise, include both mean and sd for each type, with names like
  # 'type_mean' and 'type_sd'.
  if (all(is.na(df_subset$sd))) {
    param_list <- as.list(setNames(df_subset$mean, df_subset$type))
  } else {
    param_list <- list()
    for (i in seq_len(nrow(df_subset))) {
      row <- df_subset[i, ]
      param_list[[paste0(row$type, "_mean")]] <- row$mean
      param_list[[paste0(row$type, "_sd")]] <- row$sd
    }
  }

  # Run parameter function using list
  do.call(param_function, param_list)
}
```

```{r}
#' Generate named_list with create_parameters() using values loaded from a CSV file.
#'
#' @param csv_path Path to csv file containing the parameters. Should have columns "unit", "parameter", "type", "mean" and "sd". Missing values should be marked as "NA".
#' 
#' @return Named list generated by create_parameters()

setup_param_from_csv <- function(csv_path) {
  # Load parameter data from CSV, treating "NA" as missing values
  df <- read.csv(csv_path, na.strings = "NA")
  
  # Specify mappings of create_parameters() arguments to their corresponding
  # units, parameter types and parameter classes
  param_specs <- list(
    list(name = "asu_arrivals",
         unit = "asu",
         parameter = "iat",
         param_class = create_asu_arrivals),
    list(name = "rehab_arrivals",
         unit = "rehab",
         parameter = "iat",
         param_class = create_rehab_arrivals),
    list(name = "asu_los",
         unit = "asu",
         parameter = "los",
         param_class = create_asu_los),
    list(name = "rehab_los",
         unit = "rehab",
         parameter = "los",
         param_class = create_rehab_los),
    list(name = "asu_routing",
         unit = "asu",
         parameter = "routing",
         param_class = create_asu_routing),
    list(name = "rehab_routing",
         unit = "rehab",
         parameter = "routing",
         param_class = create_rehab_routing)
  )
  param_kwargs <- list()
  for (spec in param_specs) {
    param_kwargs[[spec$name]] <- init_param_class(df, spec$unit, spec$parameter, spec$param_class)
  }

  do.call(create_parameters, param_kwargs)
}
```

```{r}
setup_param_from_csv("../inputs/parameters.csv")
```

## Calculate run time

```{r end_timer}
# Get run time in seconds
end_time <- Sys.time()
runtime <- as.numeric(end_time - start_time, units = "secs")

# Display converted to minutes and seconds
minutes <- as.integer(runtime / 60L)
seconds <- as.integer(runtime %% 60L)
cat(sprintf("Notebook run time: %dm %ds", minutes, seconds))
```

